var div=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),data=null,rdata={},u2w={};function loadJSON(t){var e=new XMLHttpRequest;e.overrideMimeType("application/json"),e.open("GET","https://tlmaurer.github.io/soccom-d3-eg/data/SOCCOMtracks.json",!0),e.onreadystatechange=function(){4==e.readyState&&"200"==e.status&&t(e.responseText)},e.send(null)}loadJSON(function(t){data=JSON.parse(t);var n=[],l={},a=0,o=["lightgray","lightgreen","lightskyblue","lightcyan","lightcoral","lightsteelblue"],r=0;data.forEach(function(t){for(var e=0;e<t.LATS.length;e++)t.LATS[e]&&t.LONS[e]&&(n.push({lat:t.LATS[e][0],lon:180<=t.LONS[e][0]?t.LONS[e][0]-360:t.LONS[e][0],date:t.DATES[e],wmo:t.WMO,uwid:t.UWID,idx:e,len:t.LATS.length,cnt:a%6}),0==e?l[t.WMO]=[r]:l[t.WMO].push(r),r+=1);a+=1});var e=960,i=960,s=d3.geo.stereographic().scale(700).rotate([0,90]).translate([480,480]).clipAngle(179.9999).clipExtent([[0,0],[e,i]]).precision(.1),c=d3.behavior.drag().on("drag",function(t,e){t.x+=d3.event.dx,t.y+=d3.event.dy,d3.select(this).attr("transform",function(t,e){return"translate("+[t.x,t.y]+")"})}),d=d3.behavior.zoom().translate([480,480]).scale(700).scaleExtent([50,3e3]).on("zoom",function(){s.translate(d.translate()).scale(d.scale()),f.selectAll("path").attr("d",g),f.append("path").datum(p).attr("class","graticule").attr("d",g),f.selectAll("circle").attr("transform",function(t){return"translate("+s([t.Lon,t.Lat])+")"}).attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("r",function(t,e){return t.idx==t.len-1?"3px":"1px"}).attr("fill",function(t,e){return t.idx==t.len-1?Date.parse(y)-Date.parse(t.date)<2592e6?"seagreen":"red":"darkgray"}).attr("opacity",function(t,e){return t.idx==t.len-1?.8:.5}).on("mouseover",function(t,e){if(t.idx==t.len-1){div.transition().duration(200).style("opacity",.9),div.html("<strong>"+t.date+"</strong><br/><strong>WMO</strong>: "+t.wmo+"<br/><strong>UWID</strong>: "+t.uwid).style("text-align","left").style("left",s([t.lon,t.lat])[0]+10+"px").style("top",s([t.lon,t.lat])[1]-50+"px").style("width","100px").style("height","40px"),d3.select(this).attr("fill","orange").attr("r","6px").attr("opacity",.5);for(var a=[],r=1;r<l[t.wmo].length;r++)a.push(n[l[t.wmo][r]]);f.selectAll("circle").data(a).attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("fill","darkgray").attr("r","2px").attr("opacity",.5)}}).on("mouseout",function(t,e){if(t.idx==t.len-1){div.transition().duration(500).style("opacity",0),Date.parse(y)-Date.parse(t.date)<2592e6?d3.select(this).attr("fill","seagreen").attr("r","3px").attr("opacity",.9):d3.select(this).attr("fill","red").attr("r","3px").attr("opacity",.9);for(var a=[],r=1;r<l[t.wmo].length;r++)a.push(n[l[t.wmo][r]]);f.selectAll("circle").data(a).attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("fill",function(t,e){return o[t.cnt]}).attr("r","1px").attr("opacity",.5)}})}),p=d3.geo.graticule(),u=d3.select("body").append("svg").attr("width",e).attr("height",i),g=d3.geo.path().projection(s),f=u.append("g");u.call(c).call(d).call(d.event),f.append("path").datum(p).attr("class","graticule").attr("d",g);d3.time.format("%m/%d/%Y");var y=new Date;d3.time.day.offset(y,-30);d3.json("https://tlmaurer.github.io/soccom-d3-eg/data/world-110m2.json",function(t,e){f.selectAll("path",".graticule").data(topojson.object(e,e.objects.countries).geometries).enter().append("path").attr("d",g),f.selectAll("circle").data(n).enter().append("circle").attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("r",function(t,e){return t.idx==t.len-1?"3px":"1px"}).attr("fill",function(t,e){return t.idx==t.len-1?Date.parse(y)-Date.parse(t.date)<2592e6?"seagreen":"red":"darkgray"}).attr("opacity",function(t,e){return t.idx==t.len-1?.8:.5}).on("mouseover",function(t,e){if(t.idx==t.len-1){div.transition().duration(200).style("opacity",.9),div.html("<strong>"+t.date+"</strong><br/><strong>WMO</strong>: "+t.wmo+"<br/><strong>UWID</strong>: "+t.uwid).style("text-align","left").style("left",s([t.lon,t.lat])[0]+10+"px").style("top",s([t.lon,t.lat])[1]-50+"px").style("width","100px").style("height","40px"),d3.select(this).attr("fill","orange").attr("r","6px").attr("opacity",.5);for(var a=[],r=1;r<l[t.wmo].length;r++)a.push(n[l[t.wmo][r]]);f.selectAll("circle").data(a).attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("fill","darkgray").attr("r","2px").attr("opacity",.5)}}).on("mouseout",function(t,e){if(t.idx==t.len-1){div.transition().duration(500).style("opacity",0),Date.parse(y)-Date.parse(t.date)<2592e6?d3.select(this).attr("fill","seagreen").attr("r","3px").attr("opacity",.9):d3.select(this).attr("fill","red").attr("r","3px").attr("opacity",.9);for(var a=[],r=1;r<l[t.wmo].length;r++)a.push(n[l[t.wmo][r]]);f.selectAll("circle").data(a).attr("cx",function(t){return s([t.lon,t.lat])[0]}).attr("cy",function(t){return s([t.lon,t.lat])[1]}).attr("fill",function(t,e){return o[t.cnt]}).attr("r","1px").attr("opacity",.5)}})})});var ordinal=d3.scale.ordinal().domain(["Active float","Inactive float"]).range(["seagreen","red"]),legsvg=d3.select("#legend").append("svg");legsvg.append("g").attr("class","legendfloat").attr("transform","translate(20,20)");var legendflt=d3.legend.color().shape("path",d3.svg.symbol().type("circle").size(100)()).shapePadding(10).scale(ordinal);legsvg.select(".legendfloat").call(legendflt);